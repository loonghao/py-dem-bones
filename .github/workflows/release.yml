name: Release

on:
  push:
    tags:
      - 'v*'  # 匹配所有版本标签，如 v0.1.0
  workflow_dispatch:
    inputs:
      fast-mode:
        description: '快速模式 (减少构建变体)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

# 并发控制，避免重复运行
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 快速构建模式 - 仅在手动触发时运行
  fast-build:
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.fast-mode == 'true' }}
    name: Fast Build Python ${{ matrix.python-version }} on ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # 主要平台和版本组合
          - os: ubuntu-latest
            python-version: '3.11'  # 最新稳定版
          - os: macos-latest
            python-version: '3.11'  # 最新稳定版
          - os: windows-latest
            python-version: '3.11'  # 最新稳定版
          # Python 3.7 兼容性测试
          - os: ubuntu-20.04
            python-version: '3.7'
    
    uses: ./.github/workflows/reusable-jobs.yml
    with:
      python-version: ${{ matrix.python-version }}
      os: ${{ matrix.os }}
      job-type: 'build'

  # 使用 cibuildwheel 构建跨平台 wheel
  build-wheels:
    name: Build wheels on ${{ matrix.os }}
    if: ${{ !(github.event_name == 'workflow_dispatch' && github.event.inputs.fast-mode == 'true') }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, windows-2019, macos-13, macos-14]
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # 初始化 git 子模块
      - name: Initialize git submodules
        shell: bash
        run: |
          git config --global url.https://github.com/.insteadOf git@github.com:
          git config --global url.https://.insteadOf git://
          git submodule sync
          git submodule update --init --recursive
      
      # 缓存 Eigen 库
      - name: Cache Eigen library
        uses: actions/cache@v4
        with:
          path: extern/eigen
          key: ${{ runner.os }}-eigen-${{ hashFiles('.github/scripts/*/setup_eigen.sh') }}
          restore-keys: |
            ${{ runner.os }}-eigen-
      
      # 安装 Eigen (Linux)
      - name: Install Eigen (Linux)
        if: ${{ runner.os == 'Linux' }}
        shell: bash
        run: |
          if [ -d "extern/eigen/Eigen" ]; then
            echo "Eigen already installed, skipping..."
          else
            bash .github/scripts/linux/setup_eigen.sh
          fi
      
      # 安装 Eigen (macOS)
      - name: Install Eigen (macOS)
        if: ${{ runner.os == 'macOS' }}
        shell: bash
        run: |
          if [ -d "extern/eigen/Eigen" ]; then
            echo "Eigen already installed, skipping..."
          else
            bash .github/scripts/mac/setup_eigen.sh
          fi
      
      # 安装 Eigen (Windows)
      - name: Install Eigen (Windows)
        if: ${{ runner.os == 'Windows' }}
        shell: bash
        run: |
          if [ -d "extern/eigen/Eigen" ]; then
            echo "Eigen already installed, skipping..."
          else
            bash .github/scripts/win/setup_eigen.sh
          fi
      
      # 设置 macOS 特定环境
      - name: Setup macOS
        if: runner.os == 'macOS'
        run: |
          echo "FC=gfortran-13" >> $GITHUB_ENV
          echo "F77=gfortran-13" >> $GITHUB_ENV
          echo "F90=gfortran-13" >> $GITHUB_ENV
          
          # 根据运行器设置不同的部署目标
          if [[ "${{ matrix.os }}" == "macos-14" ]]; then
            # Apple Silicon (arm64) 使用更高的部署目标
            echo "CIBW_ENVIRONMENT_MACOS=MACOSX_DEPLOYMENT_TARGET=11.0 PKG_CONFIG_PATH=$PWD/.openblas" >> $GITHUB_ENV
          else
            # Intel (x86_64) 使用较低的部署目标以保持兼容性
            echo "CIBW_ENVIRONMENT_MACOS=MACOSX_DEPLOYMENT_TARGET=10.14 PKG_CONFIG_PATH=$PWD/.openblas" >> $GITHUB_ENV
          fi
      
      # 设置 Windows 特定环境
      - name: Setup Windows
        if: runner.os == 'Windows'
        run: |
          echo "CIBW_ENVIRONMENT_WINDOWS=PKG_CONFIG_PATH=${{ github.workspace }}" >> $env:GITHUB_ENV
      
      # 使用 cibuildwheel 构建 wheel (非 Windows 环境)
      - name: Build wheels (Linux/macOS)
        if: runner.os != 'Windows'
        uses: pypa/cibuildwheel@v2.16.5
        env:
          CIBW_BUILD: "cp37-* cp38-* cp39-* cp310-* cp311-* cp312-* cp313-*"
          CIBW_SKIP: "pp* *-musllinux*"  # 跳过 PyPy 和 musllinux
          CIBW_ARCHS_MACOS: "x86_64 arm64"  # 同时构建 Intel 和 ARM 架构
          CIBW_ARCHS_LINUX: "x86_64"
          CIBW_BEFORE_ALL_LINUX: >
            yum install -y cmake ninja-build
          CIBW_BEFORE_ALL_MACOS: >
            brew install cmake ninja
          CIBW_ENVIRONMENT: >
            SKBUILD_BUILD_VERBOSE=1 FORCE_BDIST_WHEEL_PLAT=""
          CIBW_BUILD_VERBOSITY: 3
          CIBW_ENVIRONMENT_MACOS: ${{ env.CIBW_ENVIRONMENT_MACOS }}
          CIBW_ENVIRONMENT_WINDOWS: ${{ env.CIBW_ENVIRONMENT_WINDOWS }}
      
      # 在 Windows 环境中使用标准方法构建 wheel
      - name: Build wheels (Windows)
        if: runner.os == 'Windows'
        run: |
          # 安装构建依赖
          python -m pip install --upgrade pip
          python -m pip install build wheel setuptools scikit-build-core pybind11 numpy cmake

          # 安装 CMake 和 Ninja
          choco install -y cmake ninja

          # 使用专门的 Windows 构建脚本
          python tools/wheels/build_windows_wheel.py
        shell: bash
      
      # 上传构建产物
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: py-dem-bones-wheels-${{ runner.os }}
          path: ./wheelhouse/*.whl
          retention-days: 7

  # 构建 sdist
  build-sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install build wheel setuptools
      
      - name: Build sdist
        run: |
          python -m build --sdist
      
      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: py-dem-bones-sdist
          path: dist/*.tar.gz
          retention-days: 7

  # 文档构建任务
  docs:
    name: Build Documentation
    needs: [build-wheels, build-sdist]  # 添加依赖，确保在构建完成后执行
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install nox
          python -m pip install -e ".[dev,docs]"
      
      - name: Build documentation
        shell: bash
        run: |
          python -m nox -s docs
      
      - name: Upload documentation
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: docs/_build/html
          retention-days: 7

  # 发布到GitHub Releases
  github-release:
    name: Create GitHub Release
    needs: [docs, build-wheels, build-sdist]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 需要写入权限来创建release
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Prepare release assets
        run: |
          mkdir -p release_assets
          find artifacts -type f -name "*.whl" -o -name "*.tar.gz" | xargs -I{} cp {} release_assets/
          ls -la release_assets/
      
      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release v${{ steps.get_version.outputs.VERSION }}
          draft: false
          prerelease: false
          files: release_assets/*
          body: |
            ## py-dem-bones v${{ steps.get_version.outputs.VERSION }}
            
            See [CHANGELOG.md](https://github.com/loonghao/py-dem-bones/blob/main/CHANGELOG.md) for details.
            
            ### Installation
            
            ```bash
            pip install py-dem-bones==${{ steps.get_version.outputs.VERSION }}
            ```

  # 发布到PyPI
  pypi-publish:
    name: Publish to PyPI
    needs: [github-release]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # 使用OIDC进行PyPI发布
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install build twine wheel
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: py-dem-bones-*
          merge-multiple: true
      
      - name: Prepare distribution files
        run: |
          mkdir -p dist_final
          find dist -type f -name "*.whl" -o -name "*.tar.gz" | xargs -I{} cp {} dist_final/
          ls -la dist_final/
      
      - name: Verify wheel files
        run: |
          echo "Checking wheel files for correct platform tags..."
          python -m pip install wheel
          for wheel in dist_final/*.whl; do
            echo "Checking $wheel"
            python -m wheel tags $wheel
          done
      
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist_final/
          skip-existing: true
